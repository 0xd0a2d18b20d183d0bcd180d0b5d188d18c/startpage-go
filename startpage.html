<!DOCTYPE html>
<html>

<head>
    <title>Startpage</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        body {
            background-color: rgb(29, 29, 29);
        }

        input {
            background-color: rgb(29, 29, 29);
            border-color: rgb(29, 29, 29);
            color: lightgray;
        }

        #input {
            width: 99.5%;
        }

        p {
            color: lightgray;
        }

        details {
            color: lightgray;
        }
    </style>
</head>

<body>
    <form id="form">
        <input id="input" type="text" autofocus />
        <input type="submit">
    </form>
    <details>
        <summary>Info</summary>
        <div id="div"></div>
    </details>
    <details>
        <summary>How to</summary>
        <p><code>-c -s example_shortcut -u example_url -d example_description</code></p>
        <p><code>-u -s new_example_shortcut -u new_example_url -d new_example_description</code></p>
        <p><code>-d -s example_shortcut</code></p>
    </details>
    <details>
        <summary>Editor</summary>
        <form id="editor">
            <input type="radio" id="add" name="type" checked>
            <label for="add">Add</label></br>
            <input type="radio" id="update" name="type">
            <label for="update">Update</label></br>
            <input type="radio" id="delete" name="type">
            <label for="delete">Delete</label></br>

            <input id="editor_shortcut" type="text" />
            <label for="editor_shortcut">Shortcut</label></br>
            <input id="editor_url" type="text" />
            <label for="editor_url">URL</label></br>
            <input id="editor_desc" type="text" />
            <label for="editor_desc">Description</label></br>
            <input type="submit">
        </form>
    </details>
    <script>
        const input = document.getElementById("input")
        const form = document.getElementById("form")
        form.onsubmit = submit
        const editor = document.getElementById("editor")
        editor.onsubmit = submitEditor
        const info = document.getElementById("div")

        let params = new URLSearchParams(location.search);

        var data
        fetch('/items', {
            headers: {
                "X-User-UUID": params.get('uuid'),
            }
        }).then((response) => response.json())
            .then(function (json) {
                data = json

                for (key in data.Value) {
                    var forInsert = document.createElement("p")
                    forInsert.innerHTML = data.Value[key].Shortcut + " - " + data.Value[key].Desc
                    info.appendChild(forInsert)
                }
            })

        function submitEditor(event) {
            console.log("here")
            if (document.getElementById("add").checked) {
                fetch('/items', {
                    method: 'POST',
                    headers: {
                        "X-User-UUID": params.get('uuid'),
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "Shortcut": document.getElementById("editor_shortcut").value,
                        "URL": document.getElementById("editor_url").value,
                        "Desc": document.getElementById("editor_desc").value
                    })
                })
            } else if (document.getElementById("update").checked) {
                fetch('/items', {
                    method: 'PUT',
                    headers: {
                        "X-User-UUID": params.get('uuid'),
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "Shortcut": document.getElementById("editor_shortcut").value,
                        "URL": document.getElementById("editor_url").value,
                        "Desc": document.getElementById("editor_desc").value
                    })
                })
            } else if (document.getElementById("delete").checked) {
                fetch('/items', {
                    method: 'DELETE',
                    headers: {
                        "X-User-UUID": params.get('uuid'),
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "Shortcut": document.getElementById("editor_shortcut").value
                    })
                })
            }
            return false
        }

        function submit(event) {
            input.value = input.value + " "
            var domain = input.value.split(" ", 1)
            var args = input.value.replace(domain + " ", "")
            var url = domain
            if (domain[0] == "-c" || domain[0] == "--create") {
                var shortcut, url, desc
                var str = input.value.match(/"[^"]+"|'[^']+'|\S+/g)
                for (let i = 0; i < str.length; i++) {
                    if (str[i] == "-s" || str[i] == "--shortcut") {
                        shortcut = str[i + 1]
                    }
                    if (str[i] == "-u" || str[i] == "--url") {
                        url = str[i + 1]
                    }
                    if (str[i] == "-d" || str[i] == "--desc") {
                        desc = str[i + 1]
                    }
                }
                fetch('/items', {
                    method: 'POST',
                    headers: {
                        "X-User-UUID": params.get('uuid'),
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ "Shortcut": shortcut, "URL": url, "Desc": desc })
                })
            } else if (domain[0] == "-u" || domain[0] == "--update") {
                var shortcut, url, desc
                var str = input.value.match(/"[^"]+"|'[^']+'|\S+/g)
                for (let i = 0; i < str.length; i++) {
                    if (str[i] == "-s" || str[i] == "--shortcut") {
                        shortcut = str[i + 1]
                    }
                    if (str[i] == "-u" || str[i] == "--url") {
                        url = str[i + 1]
                    }
                    if (str[i] == "-d" || str[i] == "--desc") {
                        desc = str[i + 1]
                    }
                }
                fetch('/items', {
                    method: 'PUT',
                    headers: {
                        "X-User-UUID": params.get('uuid'),
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ "Shortcut": shortcut, "URL": url, "Desc": desc })
                })
            } else if (domain[0] == "-d" || domain[0] == "--delete") {
                var shortcut
                var str = input.value.match(/"[^"]+"|'[^']+'|\S+/g)
                for (let i = 0; i < str.length; i++) {
                    if (str[i] == "-s" || str[i] == "--shortcut") {
                        shortcut = str[i + 1]
                    }
                }
                fetch('/items', {
                    method: 'DELETE',
                    headers: {
                        "X-User-UUID": params.get('uuid'),
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ "Shortcut": shortcut })
                })
            } else {
                for (key in data.Value) {
                    console.log(data.Value[key])
                    if (domain[0] == data.Value[key].Shortcut) {
                        url = data.Value[key].URL + args
                    }
                }
                if (url == domain && !url.toString().includes(".")) {
                    // todo add error message
                    input.value = url
                    return false
                }
                if (!url.toString().startsWith("https://") && !url.toString().startsWith("http://")) {
                    url = "https://" + url
                }
                window.open(url, "_self")
            }
            input.value = ""
            event.preventDefault()
        }

        if (params.get('uuid') == null) {
            params.set('uuid', self.crypto.randomUUID());
            var newUrl = window.location.origin
                + window.location.pathname
                + '?' + params.toString();
            window.history.pushState({ path: newUrl }, '', newUrl);
        }
    </script>
</body>

</html>