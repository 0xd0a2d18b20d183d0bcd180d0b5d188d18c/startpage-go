<!DOCTYPE html>
<html>

<head>
    <title>Startpage</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        body {
            background-color: rgb(29, 29, 29);
            width: 98.8%;
        }

        input {
            background-color: rgb(29, 29, 29);
            border-color: rgb(29, 29, 29);
            color: lightgray;
            width: 100%;
        }

        p {
            color: lightgray;
        }

        details {
            color: lightgray;
        }
    </style>
</head>

<body>
    <form id="form">
        <input id="input" type="text" autofocus />
    </form>
    <details>
        <summary>Info</summary>
        <div id="div"></div>
    </details>
    <script>
        const input = document.getElementById("input")
        const form = document.getElementById("form")
        form.onsubmit = submit
        const info = document.getElementById("div")

        let params = new URLSearchParams(location.search);

        var data
        fetch('/items', {
            headers: {
                "X-User-UUID": params.get('uuid'),
            }
        }).then((response) => response.json())
            .then(function (json) {
                data = json

                for (key in data.Value) {
                    var forInsert = document.createElement("p")
                    forInsert.innerHTML = data.Value[key].Shortcut + " - " + data.Value[key].Desc
                    info.appendChild(forInsert)
                }
            })

        function submit(event) {
            input.value = input.value + " "
            var domain = input.value.split(" ", 1)
            var args = input.value.replace(domain + " ", "")
            var url = domain
            if (domain[0] == "-c" || domain[0] == "--create") {
                var shortcut, url, desc
                var str = input.value.match(/"[^"]+"|'[^']+'|\S+/g)
                for (let i = 0; i < str.length; i++) {
                    if (str[i] == "-s" || str[i] == "--shortcut") {
                        shortcut = str[i + 1]
                    }
                    if (str[i] == "-u" || str[i] == "--url") {
                        url = str[i + 1]
                    }
                    if (str[i] == "-d" || str[i] == "--desc") {
                        desc = str[i + 1]
                    }
                }
                fetch('/items', {
                    method: 'POST',
                    headers: {
                        "X-User-UUID": params.get('uuid'),
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ "Shortcut": shortcut, "URL": url, "Desc": desc })
                })
            } else if (domain[0] == "-u" || domain[0] == "--update") {
                var shortcut, url, desc
                var str = input.value.match(/"[^"]+"|'[^']+'|\S+/g)
                for (let i = 0; i < str.length; i++) {
                    if (str[i] == "-s" || str[i] == "--shortcut") {
                        shortcut = str[i + 1]
                    }
                    if (str[i] == "-u" || str[i] == "--url") {
                        url = str[i + 1]
                    }
                    if (str[i] == "-d" || str[i] == "--desc") {
                        desc = str[i + 1]
                    }
                }
                fetch('/items', {
                    method: 'PUT',
                    headers: {
                        "X-User-UUID": params.get('uuid'),
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ "Shortcut": shortcut, "URL": url, "Desc": desc })
                })
            } else if (domain[0] == "-d" || domain[0] == "--delete") {
                var shortcut
                var str = input.value.match(/"[^"]+"|'[^']+'|\S+/g)
                for (let i = 0; i < str.length; i++) {
                    if (str[i] == "-s" || str[i] == "--shortcut") {
                        shortcut = str[i + 1]
                    }
                }
                fetch('/items', {
                    method: 'DELETE',
                    headers: {
                        "X-User-UUID": params.get('uuid'),
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ "Shortcut": shortcut })
                })
            } else {
                for (key in data.Value) {
                    console.log(data.Value[key])
                    if (domain[0] == data.Value[key].Shortcut) {
                        url = data.Value[key].URL + args
                    }
                }
                if (url == domain && !url.toString().includes(".")) {
                    // todo add error message
                    input.value = url
                    return false
                }
                if (!url.toString().startsWith("https://") && !url.toString().startsWith("http://")) {
                    url = "https://" + url
                }
                window.open(url, "_self")
            }
            input.value = ""
            event.preventDefault()
        }

        if (params.get('uuid') == null) {
            params.set('uuid', self.crypto.randomUUID());
            var newUrl = window.location.origin
                + window.location.pathname
                + '?' + params.toString();
            window.history.pushState({ path: newUrl }, '', newUrl);
        }
    </script>
</body>

</html>
